
# rum-optimize-frontend-performance branch README

This doc explains the the customizations made in this branch for the Optimizing Frontend Performance course, as well as how to develop from this branch in the future.

## Development

The `provision.sh` script currently clones the branch when creating the course image, but will soon use a tagged `storedog` release specific to this course.

For future development that requires Storedog changes:

1. Use this `rum-optimize-frontend-performance` branch to develop and change the `provision.sh` file to use the branch instead of the tag when creating development images.
1. Once development is complete, create a new tag and update the `provision.sh` file. **DO NOT DELETE THE BRANCH**

## High Cumulative Layout Shift on homepage

Customized files:

- `services/ads/java/src/main/java/adsjava/AdsJavaApplication.java`

  - In the workshop, learners investigate the cause of a layout shift by using a waterfall graph. The ad images were originally named `1.jpg`, `2.jpg`, and `3.jpg`, and those names show up in the waterfall graph. To make the investigation easier for the learner, the `.jpg`s have been renamed and the `AdsJavaApplication.java` file has been updated accordingly.
  - The `/banners/{id}` endpoint has been changed to `/banners/{adImagePath}` for clarity. These changes also fix a bug in `ads` that returns an image unrelated to the ad data in the `frontend` service's `Ad.tsx` component.

- `services/frontend/pages/index.tsx`

  - On the `index.tsx` page, the first `<Ad>` component is now higher up on the page. When the ad image is served slowly, the rest of the page elements shift downwards. This causes high CLS scores, and the learner can see the layout shift in the viewport without scrolling down.
  - The `<Ad>` components now have an `id` prop which is used in the `Ad.tsx` file.

- `services/frontend/components/common/Ad/Ad.tsx`

  - The conditional rendering has been modified to ensure that there is a large layout shift and that the code is easier to understand for a learner.
  - The element containing the `<a>` element now has an `id` attribute. Some conditional rendering uses the `id` prop passed from `index.tsx` to provide a clear `id` attribute value for the `<div>` element that experiences the largest shift. This causes `#first-ad-container` to be the CSS selector shown in Datadog on the CLS optimization page (instead of many joined CSS selectors).

- `services/frontend/components/common/Discount/Discount.tsx`

  - Originally, the Discount component's conditional rendering causes some small layout shifts. However, sometimes the RUM SDK would capture this shift as the largest shift. To avoid this, I've updated the CSS for the Discount component so it doesn't shift at all.

How to verify on Storedog site:

- On the Storedog site, you should see the top add load after initial page load. Once the ad loads, the page contents below the ad shift downwards.

How to verify in Datadog:

- In Datadog, go to Digital Experience > Real User Monitoring > Optimization.
- In the list of Views, find the homepage `/` view (at the top of the list). The **CLS** column on the far right should be marked with an orange or red color.

## High Largest Contentful Paint on About Us page

Customized files:

- `services/backend/app/controllers/api/v2/custom_controller.rb`
- `services/backend/config/routes.rb`
- `services/frontend/pages/about-us.tsx`
- `services/frontend/public/assets/about-us-image.jpg`
- `services/puppeteer/puppeteer.js`
- `docker-compose.yml`
  - `services.backend.volumes`
  - `services.frontend.volumes`
  - `services.frontend.environment`

Created an `/about-us` page with a large stock image, `about-us-image.jpg`. `puppeteer.js` is modified to send traffic to this page via footer link clicks.

High LCP is generated by adding a new endpoint that has a delay long enough to cause "Needs Improvement" or "Poor" LCP values. The `/about-us` page sends a request to the `/about-us-api` endpoint (defined in `routes.rb` and `custom_controller.rb`) to find the image path (`about-us-image.jpg`).

How to verify on Storedog site:

- On the Storedog site, scroll down to the footer and click on **About Us**.
- The main image on the About Us page should take a long time to load.

How to verify in Datadog:

- In Datadog, go to Digital Experience > Real User Monitoring > Optimization.
- In the list of Views, find the About Us `/about-us` view. The **LCP** column should show an orange or red color, indicating poor LCP.

## High Interaction to Next Paint

Storedog's `CartSidebarView.tsx` component has been modified to introduce a delay after clicking the **PROCEED TO CHECKOUT** button.

How to verify on Storedog site:

- Go to Storedog and click on a product.
- Add the product to the cart.
- Click **PROCEED TO CHECKOUT**. You should experience a noticeable delay before the cart panel is updated.

How to verify in Datadog:

- In Datadog, go to Digital Experience > Real User Monitoring > Optimization.
- In the list of Views, several views should have a RED INP value.

## Other customizations

- Some Puppeteer sessions enter invalid discount codes. The discounts service returns a 400-level response, which shows up in Datadog RUM as a "Resource with errors". That error is silenced in this branch to allow the learner to focus only on Core Web Vitals issues. 

- In the RUM Optimization pages, the SDK finds the CSS selector of the element causing the poor vital score. In Datadog, the selectors use `\`s to escape spaces. The element causing the INP problem is a button that originally had `data-dd-action-name="Proceed\ To\ Checkout\"` but since the learner needs to find this element in the IDE (without familiarity with the Storedog code base), this could lead to unnecessary confusion. Instead, I modified all of the `data-dd-action-name` attribute values to be PascalCase rather than use spaces.
